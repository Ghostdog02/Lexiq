secrets:
  db_password:
    file: ./secrets/database/password.txt
  backend_env:
    file: ./secrets/backend/.env

services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: lexiq-database
    environment:
      ACCEPT_EULA: "Y"
    secrets: 
      - db_password
    volumes:
      - db-data:/var/opt/mssql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        export MSSQL_SA_PASSWORD=$$(cat /run/secrets/db_password)
        /opt/mssql/bin/sqlservr
    healthcheck:
      test: >
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa 
        -P "$$(cat /run/secrets/db_password)" 
        -Q "SELECT 1" -C || exit 1
      interval: 10s
      retries: 10
      start_period: 30s
      timeout: 3s
    restart: unless-stopped
  
  backend:
    image:  ${REGISTRY}/${REPO_LOWER}-backend:${BRANCH}
    container_name: lexiq-backend
    secrets:
      - backend_env
    environment:
      USE_HTTPS: "true"
      CERT_STORAGE_PATH: "/app/certs"
      CERT_PASSWORD: "${CERT_PASSWORD:-lexiq-cert-password}"
    expose:
      - "80"
      - "443"
    volumes:
      - backend-uploads:/app/wwwroot
      - backend-certs:/app/certs
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  frontend:
    image:  ${REGISTRY}/${REPO_LOWER}-frontend:${BRANCH}
    container_name: lexiq-frontend
    environment:
      ENVIRONMENT: production
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - letsencrypt-certs:/etc/letsencrypt:ro
      - certbot-webroot:/var/www/certbot:ro
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent --insecure https://localhost:443/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    container_name: lexiq-certbot
    volumes:
      - letsencrypt-certs:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped

volumes:
  db-data:
  backend-uploads:
  backend-certs:
  letsencrypt-certs:
  certbot-webroot: