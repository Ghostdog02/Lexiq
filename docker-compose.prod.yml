secrets:
  db_password:
    file: ./secrets/database/password.txt
  backend_env:
    file: ./secrets/backend/.env

services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: lexiq-database
    environment:
      ACCEPT_EULA: "Y"
    secrets: 
      - db_password
    volumes:
      - db-data:/var/opt/mssql
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        export MSSQL_SA_PASSWORD=$$(cat /run/secrets/db_password)
        /opt/mssql/bin/sqlservr
    healthcheck:
      test: >
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa 
        -P "$$(cat /run/secrets/db_password)" 
        -Q "SELECT 1" -C || exit 1
      interval: 10s
      retries: 10
      start_period: 30s
      timeout: 3s
    restart: unless-stopped
    logging:
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    image:  ${REGISTRY}/${REPO_LOWER}-backend:${BRANCH}
    container_name: lexiq-backend
    secrets:
      - backend_env
    environment:
      # Suppress informational ASP.NET Core output; only warnings and errors
      # surface in docker compose logs. Override per-namespace as needed.
      Logging__LogLevel__Default: Warning
      Logging__LogLevel__Microsoft.AspNetCore: Warning
      Logging__LogLevel__Microsoft.EntityFrameworkCore: Warning
    expose:
      - "8080"
    volumes:
      - backend-uploads:/app/wwwroot
      - backend-dataprotection:/app/dataprotection-keys
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null -T 10 http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    logging:
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    image:  ${REGISTRY}/${REPO_LOWER}-frontend:${BRANCH}
    container_name: lexiq-frontend
    environment:
      ENVIRONMENT: production
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - letsencrypt-certs:/etc/letsencrypt:ro
      - certbot-webroot:/var/www/certbot:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null -T 10 http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      options:
        max-size: "10m"
        max-file: "3"

  certbot:
    image: certbot/certbot:latest
    container_name: lexiq-certbot
    volumes:
      - letsencrypt-certs:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet --deploy-hook \"find /etc/letsencrypt/archive -type d -exec chmod 755 {} + && find /etc/letsencrypt/archive -type f -exec chmod 644 {} +\"; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped
    logging:
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  db-data:
  backend-uploads:
  backend-dataprotection:
  letsencrypt-certs:
  certbot-webroot: