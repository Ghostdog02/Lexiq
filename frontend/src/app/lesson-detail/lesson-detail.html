<div class="lesson-detail-container">
  <!-- Header -->
  <header class="lesson-header">
    <button class="btn-back" (click)="goBack()" aria-label="Go back to home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    @if (lesson) {
      <div class="header-info">
        <h1 class="lesson-title">{{ lesson.title }}</h1>
        <p class="lesson-meta">
          <span class="meta-item">
            <span class="icon">&#x23F1;</span>
            {{ lesson.estimatedDuration }} min
          </span>
          <span class="meta-item">
            <span class="icon">&#x1F9E9;</span>
            {{ lesson.exercises.length }} exercises
          </span>
          @if (totalPossibleXp > 0) {
            <span class="meta-item">
              <span class="icon">&#x2B50;</span>
              {{ earnedXp }} / {{ totalPossibleXp }} XP
            </span>
          }
        </p>
      </div>

      <!-- Progress bar -->
      @if (currentView === 'exercises' && lesson.exercises.length > 0) {
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="exerciseProgress"></div>
          </div>
          <span class="progress-text">{{ currentExerciseIndex + 1 }} / {{ lesson.exercises.length }}</span>
        </div>
      }
    }
  </header>

  <!-- Main content -->
  <main class="lesson-main" role="main">
    @if (!lesson) {
      <!-- No lesson found -->
      <div class="empty-state">
        <span class="empty-icon">&#x1F4DA;</span>
        <h2>Lesson not found</h2>
        <p>The lesson you're looking for doesn't exist or hasn't been created yet.</p>
        <button class="btn primary" (click)="goBack()">Go Back Home</button>
      </div>
    } @else {
      <!-- Content View -->
      @if (currentView === 'content') {
        <div class="content-view fade-in">
          <!-- Lesson description -->
          <div class="section-wrapper">
            <h3 class="section-label"><span class="icon">ðŸ“‹</span> Instructions</h3>
            <div class="lesson-description card">
              <p>{{ lesson.description }}</p>
            </div>
          </div>

          <!-- Rendered markdown content -->
          @if (lesson.content) {
            <div class="section-wrapper">
              <h3 class="section-label" id="second-section-label"><span class="icon">ðŸ“–</span> Textbook Content</h3>
              <div class="lesson-content card">
                <div class="markdown-content" [innerHTML]="parseContent(lesson.content)"></div>
              </div>
            </div>
          }

          <!-- Start exercises button -->
          @if (lesson.exercises.length > 0) {
            <div class="action-section">
              <button class="btn primary large" (click)="startExercises()" aria-label="Start exercises">
                <span class="icon">&#x1F3AF;</span>
                Start Exercises
              </button>
              <p class="action-hint">{{ lesson.exercises.length }} exercises to complete</p>
            </div>
          } @else {
            <div class="action-section">
              <button class="btn no-exercises-btn large" disabled aria-label="No exercises available">
                <span class="icon">&#x1F4AD;</span>
                This lesson has no exercises yet
              </button>
              <p class="action-hint">Add exercises to activate this lesson</p>
            </div>
          }
        </div>
      }

      <!-- Exercises View -->
      @if (currentView === 'exercises' && currentExercise) {
        <div class="exercises-view fade-in">
          <!-- Exercise card -->
          <div class="exercise-card card">
            <!-- Exercise header -->
            <div class="exercise-header">
              <span class="exercise-type-badge" [attr.data-type]="currentExercise.exerciseType">
                @switch (currentExercise.exerciseType) {
                  @case (ExerciseType.MultipleChoice) { Multiple Choice }
                  @case (ExerciseType.FillInBlank) { Fill in the Blank }
                  @case (ExerciseType.Translation) { Translation }
                  @case (ExerciseType.Listening) { Listening }
                }
              </span>
              @if (currentExercise.points) {
                <span class="points-badge">+{{ currentExercise.points }} XP</span>
              }
            </div>

            <!-- Exercise title and instructions -->
            @if (currentExercise.title) {
              <h2 class="exercise-title">{{ currentExercise.title }}</h2>
            }
            @if (currentExercise.instructions) {
              <p class="exercise-instructions">{{ currentExercise.instructions }}</p>
            }

            <!-- Exercise content based on type -->
            <div class="exercise-content">
              @switch (currentExercise.exerciseType) {
                <!-- Multiple Choice -->
                @case (ExerciseType.MultipleChoice) {
                  <div class="multiple-choice">
                    <div class="options-list">
                      @for (option of $any(currentExercise).options; track $index) {
                        <button
                          type="button"
                          class="option-btn"
                          [class]="getOptionClass($index, option.isCorrect)"
                          [disabled]="currentAnswer?.isSubmitted"
                          (click)="selectMultipleChoiceOption($index)"
                          [attr.aria-pressed]="isOptionSelected($index)"
                        >
                          <span class="option-letter">{{ ['A', 'B', 'C', 'D', 'E', 'F'][$index] }}</span>
                          <span class="option-text">{{ option.optionText }}</span>
                          @if (currentAnswer?.isSubmitted) {
                            @if (option.isCorrect) {
                              <span class="result-icon correct">&#x2713;</span>
                            } @else if (isOptionSelected($index)) {
                              <span class="result-icon incorrect">&#x2717;</span>
                            }
                          }
                        </button>
                      }
                    </div>
                  </div>
                }

                <!-- Fill in the Blank -->
                @case (ExerciseType.FillInBlank) {
                  <div class="fill-in-blank">
                    <div class="question-display">
                      <p class="question-text">{{ $any(currentExercise).question }}</p>
                    </div>
                    <div class="answer-input-wrapper">
                      <input
                        type="text"
                        class="answer-input"
                        [class.correct]="currentAnswer?.isSubmitted && currentAnswer?.isCorrect"
                        [class.incorrect]="currentAnswer?.isSubmitted && !currentAnswer?.isCorrect"
                        placeholder="Type your answer..."
                        [value]="currentAnswer?.answer || ''"
                        (input)="updateAnswer($any($event.target).value)"
                        [disabled]="currentAnswer?.isSubmitted"
                        aria-label="Your answer"
                      />
                    </div>
                    @if (currentAnswer?.isSubmitted && !currentAnswer?.isCorrect) {
                      <div class="correct-answer-reveal">
                        <span class="label">Correct answer:</span>
                        <span class="answer">{{ $any(currentExercise).correctAnswer }}</span>
                      </div>
                    }
                  </div>
                }

                <!-- Translation -->
                @case (ExerciseType.Translation) {
                  <div class="translation">
                    <div class="source-section">
                      <div class="lang-badge">{{ $any(currentExercise).sourceLanguageCode | uppercase }}</div>
                      <p class="source-text">{{ $any(currentExercise).sourceText }}</p>
                    </div>
                    <div class="arrow-divider">
                      <span>&#x27A1;</span>
                    </div>
                    <div class="target-section">
                      <div class="lang-badge">{{ $any(currentExercise).targetLanguageCode | uppercase }}</div>
                      <textarea
                        class="translation-input"
                        [class.correct]="currentAnswer?.isSubmitted && currentAnswer?.isCorrect"
                        [class.incorrect]="currentAnswer?.isSubmitted && !currentAnswer?.isCorrect"
                        placeholder="Write your translation..."
                        [value]="currentAnswer?.answer || ''"
                        (input)="updateAnswer($any($event.target).value)"
                        [disabled]="currentAnswer?.isSubmitted"
                        rows="3"
                        aria-label="Your translation"
                      ></textarea>
                    </div>
                    @if (currentAnswer?.isSubmitted && !currentAnswer?.isCorrect) {
                      <div class="correct-answer-reveal">
                        <span class="label">Expected translation:</span>
                        <span class="answer">{{ $any(currentExercise).targetText }}</span>
                      </div>
                    }
                  </div>
                }

                <!-- Listening -->
                @case (ExerciseType.Listening) {
                  <div class="listening">
                    <div class="audio-section">
                      @if ($any(currentExercise).audioUrl) {
                        <audio controls class="audio-player">
                          <source [src]="$any(currentExercise).audioUrl" type="audio/mpeg">
                          Your browser does not support the audio element.
                        </audio>
                      } @else {
                        <div class="no-audio">
                          <span class="icon">&#x1F50A;</span>
                          <p>No audio available</p>
                        </div>
                      }
                      @if ($any(currentExercise).maxReplays) {
                        <p class="replay-hint">Max replays: {{ $any(currentExercise).maxReplays }}</p>
                      }
                    </div>
                    <div class="answer-input-wrapper">
                      <input
                        type="text"
                        class="answer-input"
                        [class.correct]="currentAnswer?.isSubmitted && currentAnswer?.isCorrect"
                        [class.incorrect]="currentAnswer?.isSubmitted && !currentAnswer?.isCorrect"
                        placeholder="Type what you hear..."
                        [value]="currentAnswer?.answer || ''"
                        (input)="updateAnswer($any($event.target).value)"
                        [disabled]="currentAnswer?.isSubmitted"
                        aria-label="Your answer"
                      />
                    </div>
                    @if (currentAnswer?.isSubmitted && !currentAnswer?.isCorrect) {
                      <div class="correct-answer-reveal">
                        <span class="label">Correct answer:</span>
                        <span class="answer">{{ $any(currentExercise).correctAnswer }}</span>
                      </div>
                    }
                  </div>
                }
              }
            </div>

            <!-- Feedback after submission -->
            @if (currentAnswer?.isSubmitted) {
              <div class="feedback" [class.correct]="currentAnswer?.isCorrect" [class.incorrect]="!currentAnswer?.isCorrect">
                @if (currentAnswer?.isCorrect) {
                  <span class="feedback-icon">&#x1F389;</span>
                  <span class="feedback-text">Correct! Great job!</span>
                } @else {
                  <span class="feedback-icon">&#x1F914;</span>
                  <span class="feedback-text">Not quite. Keep practicing!</span>
                }
                @if (currentExercise.explanation) {
                  <p class="explanation">{{ currentExercise.explanation }}</p>
                }
              </div>
            }

            <!-- Action buttons -->
            <div class="exercise-actions">
              @if (!currentAnswer?.isSubmitted) {
                <button
                  class="btn primary"
                  [disabled]="!currentAnswer?.answer"
                  (click)="submitAnswer()"
                  aria-label="Submit answer"
                >
                  Check Answer
                </button>
              } @else {
                @if (currentExerciseIndex < lesson.exercises.length - 1) {
                  <button class="btn primary" (click)="nextExercise()" aria-label="Next exercise">
                    Continue
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                } @else {
                  <button class="btn success" (click)="finishLesson()" aria-label="Finish lesson">
                    <span class="icon">&#x1F3C6;</span>
                    Complete Lesson
                  </button>
                }
              }
            </div>
          </div>

          <!-- Navigation dots -->
          <div class="exercise-nav">
            <button
              class="nav-btn"
              [disabled]="currentExerciseIndex === 0"
              (click)="previousExercise()"
              aria-label="Previous exercise"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>

            <div class="nav-dots">
              @for (exercise of lesson.exercises; track $index) {
                <button
                  class="nav-dot"
                  [class.active]="$index === currentExerciseIndex"
                  [class.completed]="answers.get($index)?.isSubmitted"
                  [class.correct]="answers.get($index)?.isCorrect === true"
                  [class.incorrect]="answers.get($index)?.isCorrect === false"
                  (click)="currentExerciseIndex = $index"
                  [attr.aria-label]="'Go to exercise ' + ($index + 1)"
                ></button>
              }
            </div>

            <button
              class="nav-btn"
              [disabled]="currentExerciseIndex === lesson.exercises.length - 1"
              (click)="nextExercise()"
              aria-label="Next exercise"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <!-- Back to content link -->
          <button class="btn-link" (click)="goToContent()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to lesson content
          </button>
        </div>
      }

    }
  </main>
</div>
