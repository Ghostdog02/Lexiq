name: "Continuous Delivery"

on:
  workflow_call:
    inputs:
      config-path:
        required: true
        type: string
    secrets:
      HETZNER_PROD_PRIVATE_SSH_KEY:
        required: true
      HETZNER_PROD_SSH_KEY_PASSPHRASE:
        required: true
      HETZNER_PROD_HOST:
        required: true
      HETZNER_PROD_USERNAME:
        required: true
      HETZNER_PROD_SSH_PORT:
        required: true

env:
  DEPLOY_ENV: production

jobs:
  deploy:
    env:
      REGISTRY: ghcr.io
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          BRANCH="${{ github.ref_name }}"
          echo "BRANCH=${BRANCH//\//-}" >> $GITHUB_ENV

      - name: Copy deployment assets to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          source: "scripts/deploy.sh,scripts/verify-deployment.sh,docker-compose.prod.yml,scripts/init-letsencrypt.sh"
          target: "/tmp/deploy_assets_${{ github.run_id }}"
          strip_components: 0

      - name: Deploy and Verify
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          command_timeout: 30m
          script: |
            set -e
            ASSETS="/tmp/deploy_assets_${{ github.run_id }}"
            TARGET_DIR="/home/${{ secrets.HETZNER_PROD_USERNAME }}/production"

            mkdir -p "$TARGET_DIR"
            cp "$ASSETS/docker-compose.prod.yml" "$TARGET_DIR/docker-compose.yml"
            cp "$ASSETS/scripts/init-letsencrypt.sh" "$TARGET_DIR/scripts/init-letsencrypt.sh"

            # Create environment file
            cat > /tmp/.deploy.env << ENVEOF
            HOME_DIR="/home/${{ secrets.HETZNER_PROD_USERNAME }}"
            BRANCH="${{ env.BRANCH }}"
            REPO="${{ github.repository }}"
            COMMIT="${{ github.sha }}"
            ACTOR="${{ github.actor }}"
            DOCKER_PASSWORD="${{ secrets.GITHUB_TOKEN }}"
            DOCKER_USERNAME="${{ github.actor }}"
            DEPLOY_DIR="$TARGET_DIR"
            REGISTRY="${{ env.REGISTRY }}"
            REPO_LOWER="${{ env.REPO_LOWER }}"
            EVENT="${{ github.event_name }}"
            ENVEOF

            chmod 600 /tmp/.deploy.env
            bash "$ASSETS/scripts/deploy.sh"

            export DEPLOY_DIR="$TARGET_DIR"
            bash "$ASSETS/scripts/verify-deployment.sh"

      - name: Cleanup Server
        if: always()
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          script: |
            rm -rf "/tmp/deploy_assets_${{ github.run_id }}"
            rm -f /tmp/.deploy.env
            docker image prune -f

      - name: Final Status Notices
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice::✅ Deployment successful!"
          else
            echo "::error::❌ Deployment failed!"
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `❌ **Deployment failed!**\n\nCheck the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`;
            const payload = context.payload.pull_request ? 
              { issue_number: context.payload.pull_request.number } : 
              { commit_sha: context.sha };
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({ ...context.repo, ...payload, body: message });
            } else {
              await github.rest.repos.createCommitComment({ ...context.repo, ...payload, body: message });
            }