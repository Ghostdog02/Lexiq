name: "CI/CD - Docker Compose Deployment"

on:
  workflow_dispatch:
  push:
    branches:
      - Ghostdog02-patch-1
      - master
  pull_request:
    branches:
      - Ghostdog02-patch-1
      - master

jobs:
  ci-on-hetzner:
    name: "CI on Ephemeral Hetzner Runner"
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.create-runner.outputs.label }}
      server_id: ${{ steps.create-runner.outputs.server_id }}
    
    steps:
      - name: Create temporary Hetzner runner
        id: create-runner
        uses: Cyclenerd/hcloud-github-runner@v1
        with:
          mode: create
          github_token: ${{ secrets.RUNNER_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          server_type: cx22
          location: nbg1
          image: debian-13  # Using Debian 13

  build-and-test:
    name: "Build and Test with Docker"
    needs: ci-on-hetzner
    runs-on: ${{ needs.ci-on-hetzner.outputs.label }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Docker on Debian 13
        run: |
          #Uninstall all conflicting packages:
          sudo apt remove $(dpkg --get-selections docker.io docker-compose docker-doc podman-docker containerd runc | cut -f1)

          # Update package index
          apt-get update
          
          # Install prerequisites
          apt-get install -y ca-certificates curl gnupg lsb-release
          
          # Add Docker's official GPG key
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg
          
          # Set up the Docker repository
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
            $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          # Install Docker Engine
          apt-get update
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

          systemctl start docker
          systemctl enable docker

          docker --version
          docker compose version
      
      - name: Build Docker images
        run: |
          docker compose build
      


  deploy-to-production:
    name: "Deploy to Persistent Production Server"
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/Ghostdog02-patch-1'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy with Docker Compose to Hetzner (Debian 13)
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          envs: GITHUB_TOKEN
          script: |
            set -e  # Exit on any error
            set -o pipefail  # Fail if any command in a pipe fails
            
            echo "Deploying to production server with Docker Compose..."
            
            # Navigate to app directory
            cd ~/production || { echo "Failed to cd to ~/production"; exit 1; }
            
            # Configure git user
            git config --global user.name ${{ secrets.GIT_USER_NAME }}
            git config --global user.email ${{ secrets.GIT_USER_EMAIL }}
            git config --global user.password ${{ secrets.GIT_USER_PASSWORD }}

            # Config GitHub PAT
            git config --global url."https://$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"

            git clone ${{ github.repository }}

            output=$(git remote -v)
            if [[ -n "$output" ]]; then
                echo "Remotes exist"
            else
                
                # git pull origin ${{ github.ref_name }} || { echo "Git pull failed"; exit 1; }
            fi   

            git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}

            # Clear GitHub PAT
            git config --global --unset url."https://$GITHUB_TOKEN@github.com/".insteadOf
            
            # Pull latest images
            docker compose pull || { echo "Docker compose pull failed"; exit 1; }
            
            # Stop and remove old containers
            docker compose down || { echo "Docker compose down failed"; exit 1; }
            
            # Start new containers in detached mode
            docker compose up -d || { echo "Docker compose up failed"; exit 1; }
            
            # Clean up unused images
            docker image prune -f
            
            # Show running containers
            docker compose ps
            
            echo "Deployment complete!"
        env:
            GITHUB_TOKEN: ${{ secrets.GIT_READONLY_TOKEN }}
      - name: Health check
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY}}
          # passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          password: ${{ secrets.HETZNER_PROD_PASSWORD }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          script: |
            set -e
            set -o pipefail
          
            # Wait a few seconds for containers to start
            sleep 10
            
            # Check if containers are running
            cd ~/production

            
            # Get container status
            RUNNING=$(docker compose ps --status running --quiet | wc -l)
            
            if [ "$RUNNING" -eq 0 ]; then
              echo "ERROR: No containers are running!"
              docker compose ps
              docker compose logs --tail=50
              exit 1
            fi

            docker compose ps

            echo "Deployment complete!"
            
  cleanup-ci-runner:
    name: "Cleanup CI Runner"
    needs:
      - ci-on-hetzner
      - build-and-test
    runs-on: ubuntu-latest
    if: ${{ always() }}
    
    steps:
      - name: Delete temporary runner
        uses: Cyclenerd/hcloud-github-runner@v1
        with:
          mode: delete
          github_token: ${{ secrets.RUNNER_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          name: ${{ needs.ci-on-hetzner.outputs.label }}
          server_id: ${{ needs.ci-on-hetzner.outputs.server_id }}
          
