name: "CI/CD - Docker Compose Deployment"

on:
  workflow_dispatch:
  push:
    branches:
      - Ghostdog02-patch-1
      - master
  pull_request:
    branches:
      - Ghostdog02-patch-1
      - master

jobs:
  build-and-test:
    name: "Build and Test with Docker"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: docker compose build

  deploy-to-production:
    name: "Deploy to Persistent Production Server"
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/Ghostdog02-patch-1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose to Hetzner (Debian 13)
        uses: appleboy/ssh-action@v1.2.4
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_READONLY_TOKEN }}
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          envs: GITHUB_TOKEN
          script: |
            set -euo pipefail

            echo "Deploying to production server with Docker Compose..."

            # Use apt with sudo and correct command
            echo "${{ secrets.HETZNER_PROD_DEVELOPER_PASSWORD }}" | sudo -S apt update
            sudo apt upgrade -y

            cd ~/production || { echo "Failed to cd to ~/production"; exit 1; }

            # Ensure git is installed
            if ! command -v git >/dev/null 2>&1; then
              sudo apt install -y git
            fi

            # If repo exists, pull; otherwise clone
            if [ -d .git ]; then
              git fetch --all --prune
              git checkout "${{ github.ref_name }}" || git checkout -b "${{ github.ref_name }}"
              git pull origin "${{ github.ref_name }}"
            else
              # Configure temporary PAT for clone
              git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
              git clone "https://github.com/${{ github.repository }}.git" .
              git checkout -b "${{ github.ref_name }}" origin/"${{ github.ref_name }}" || true
              git config --global --unset url."https://${GITHUB_TOKEN}@github.com/".insteadOf
            fi

            # Pull, stop, and start containers
            docker compose pull
            docker compose down
            docker compose up -d

            docker image prune -f
            docker compose ps
            echo "Deployment complete!"

      - name: Health check
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
          password: ${{ secrets.HETZNER_PROD_PASSWORD }}
          port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
          script: |
            set -e
            set -o pipefail

            # Wait a few seconds for containers to start
            sleep 10

            cd ~/production

            # Get container status
            RUNNING=$(docker compose ps --status running --quiet | wc -l)

            if [ "$RUNNING" -eq 0 ]; then
              echo "ERROR: No containers are running!"
              docker compose ps
              docker compose logs --tail=50
              exit 1
            fi

            docker compose ps

            echo "Deployment complete!"