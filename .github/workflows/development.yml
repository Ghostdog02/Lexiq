name: "CI/CD - Docker Compose Deployment"

on:
  workflow_dispatch:
  push:
    branches:
      - Ghostdog02-patch-1
      - master
  pull_request:
    branches:
      - Ghostdog02-patch-1
      - master

jobs:
  ci-on-hetzner:
    name: "CI on Ephemeral Hetzner Runner"
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.create-runner.outputs.label }}
      server_id: ${{ steps.create-runner.outputs.server_id }}
    
    steps:
      - name: Create temporary Hetzner runner
        id: create-runner
        uses: Cyclenerd/hcloud-github-runner@v1
        with:
          mode: create
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          server_type: cx22
          location: nbg1
          image: debian-13  # Using Debian 13

  build-and-test:
    name: "Build and Test with Docker"
    needs: ci-on-hetzner
    runs-on: ${{ needs.ci-on-hetzner.outputs.label }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Docker on Debian 13
        run: |
          #Uninstall all conflicting packages:
          sudo apt remove $(dpkg --get-selections docker.io docker-compose docker-doc podman-docker containerd runc | cut -f1)

          # Update package index
          apt-get update
          
          # Install prerequisites
          apt-get install -y ca-certificates curl gnupg lsb-release
          
          # Add Docker's official GPG key
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg
          
          # Set up the Docker repository
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
            $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          # Install Docker Engine
          apt-get update
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

          systemctl start docker
          systemctl enable docker

          docker --version
          docker compose version
      
      - name: Build Docker images
        run: |
          docker compose build
      


  deploy-to-production:
    name: "Deploy to Persistent Production Server"
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/Ghostdog02-patch-1'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy with Docker Compose to Hetzner (Debian 13)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_SSH_KEY }}
          script: |
            echo "Deploying to production server with Docker Compose..."
            
            # Navigate to app directory
            cd ~/app/current
            
            git pull origin ${{ github.ref_name }}
            
            # Pull latest images
            docker compose pull
            
            # Stop and remove old containers
            docker compose down
            
            # Start new containers in detached mode
            docker compose up -d
            
            # Clean up unused images
            docker image prune -f
            
            # Show running containers
            docker compose ps
            
            echo "Deployment complete!"
      
      - name: Health check
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HETZNER_PROD_HOST }}
          username: ${{ secrets.HETZNER_PROD_USERNAME }}
          key: ${{ secrets.HETZNER_PROD_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
          script: |
            # Wait a few seconds for containers to start
            sleep 10
            
            # Check if containers are running
            cd ~/app/current
            if docker compose ps | grep -q "Up"; then
              echo "Containers are running"
            else
              echo "Deployment failed - containers not running"
              docker compose logs
              exit 1
            fi


            
  cleanup-ci-runner:
    name: "Cleanup CI Runner"
    needs:
      - ci-on-hetzner
      - build-and-test
    runs-on: ubuntu-latest
    if: ${{ always() }}
    
    steps:
      - name: Delete temporary runner
        uses: Cyclenerd/hcloud-github-runner@v1
        with:
          mode: delete
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          name: ${{ needs.ci-on-hetzner.outputs.label }}
          server_id: ${{ needs.ci-on-hetzner.outputs.server_id }}
          