  name: Deploy to Production

  on:
    workflow_call:
      inputs:
        config-path:
          required: true
          type: string
      secrets:
        HETZNER_PROD_PRIVATE_SSH_KEY:
          required: true
        HETZNER_PROD_SSH_KEY_PASSPHRASE:
          required: true
        HETZNER_PROD_HOST:
          required: true
        HETZNER_PROD_USERNAME:
          required: true
        HETZNER_PROD_SSH_PORT:
          required: true

  env:
    DEPLOY_ENV: production

  jobs:
    deploy:
      permissions:
        contents: read
        packages: read

      name: Deploy to Hetzner
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v6

        - name: Copy deployment script to server
          uses: appleboy/scp-action@v0.1.7
          with:
            host: ${{ secrets.HETZNER_PROD_HOST }}
            username: ${{ secrets.HETZNER_PROD_USERNAME }}
            key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
            passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
            port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
            source: "scripts/deploy.sh"
            target: "/tmp/"

        - name: Copy docker-compose and nginx files to server
          uses: appleboy/scp-action@v0.1.7
          with:
            host: ${{ secrets.HETZNER_PROD_HOST }}
            username: ${{ secrets.HETZNER_PROD_USERNAME }}
            key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
            passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
            port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
            source: "docker-compose.prod.yml,nginx.conf"
            target: "/home/${{ secrets.HETZNER_PROD_USERNAME }}/production"

        - name: Deploy with Docker Compose to Hetzner (Debian 13)
          uses: appleboy/ssh-action@v1.2.4
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            host: ${{ secrets.HETZNER_PROD_HOST }}
            username: ${{ secrets.HETZNER_PROD_USERNAME }}
            key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
            passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
            port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
            envs: GITHUB_TOKEN
            command_timeout: 30m
            script: |
              chmod +x /tmp/scripts/deploy.sh
              mv /home/${{ secrets.HETZNER_PROD_USERNAME }}/production/docker-compose.prod.yml /home/${{ secrets.HETZNER_PROD_USERNAME }}/production/docker-compose.yml
              /tmp/scripts/deploy.sh

        - name: Cleanup
          if: always()
          uses: appleboy/ssh-action@v1.2.4
          with:
            host: ${{ secrets.HETZNER_PROD_HOST }}
            username: ${{ secrets.HETZNER_PROD_USERNAME }}
            key: ${{ secrets.HETZNER_PROD_PRIVATE_SSH_KEY }}
            passphrase: ${{ secrets.HETZNER_PROD_SSH_KEY_PASSPHRASE }}
            port: ${{ secrets.HETZNER_PROD_SSH_PORT }}
            script: |
              rm -f /tmp/scripts/deploy.sh

        - name: Deployment Status
          if: always()
          run: |
            if [ $? -eq 0 ]; then
              echo "::notice::✅ Deployment successful!"
            else
              echo "::error::❌ Deployment failed!"
              exit 1
            fi

        - name: Notify on failure
          if: failure()
          uses: actions/github-script@v8
          with:
            script: |
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '❌ Deployment failed! Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
              })